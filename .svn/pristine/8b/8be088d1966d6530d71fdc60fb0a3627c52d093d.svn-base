$('#manager-inside-render').html('<%= j render 'modal_form' %>');
console.log("EDIT MODAL");
$('.form-button input').click(function(){
	$('#inside-manager').modal('hide');
});

  $('#start-date').datepicker();
  $('#end-date').datepicker();
  console.log("grey");
  var questions;
	  questions = $('.remove_fields').length;
	  console.log(questions);
	  $('form').on('click', '.remove_fields', function() {
	    if (questions > 1) {
	      $(this).prev('input[type=hidden]').val('1');
	      $(this).closest('.field').detach();
	      event.preventDefault();
	      questions = questions - 1;
	      console.log(questions);
	      if (questions === 1) {
	        $('.remove_fields').hide();
	      }
	    }
	  });
	  $('#add_field').on('click', function() {
	  	var last = $('.question-field').last();
	    var clone = $('.question-field').last().clone();
	        $(clone).insertAfter(last);
	        $('.question-field:last select').each(function(){
		    	var div_id = "#"+$('.question-field:last select').attr('id');
		    	var div_id_no = $('.question-field:last select').attr('id');
			  	console.log("Div ID =" + div_id);
			  	var split = div_id.split('_');
			  	var iterator = $('.question-field').length - 1;
			  	var weirderator = iterator - 1;
			  	var metric_div = "#campaign_questions_attributes_"+weirderator+"_metric_id";
			  	console.log("Metric ID =" + metric_div);
			  	if (div_id == metric_div){
			  		console.log("iterator=" + iterator);
			  		$(this).attr('id', "campaign_questions_attributes_"+iterator+"_metric_id");
			  		$(this).attr('name', "campaign[questions_attributes]["+iterator+"][metric_id]");
			  		$("#campaign_questions_attributes_"+iterator+"_kpi_id").find('option').fadeOut().remove();
			  		$(this).val("");
			  		
			  		$('.question-field select').change(function(){
				  	console.log("LAST: " + $('.question-field:last select').attr('id'));
				  	console.log("fired");
				  	var div_id = "#"+$(this).attr('id');
				  	console.log(div_id);
				  	var split = div_id.split('_');
				  	var iterator = split[3];
				  	var value = $(this,'option:selected').val();
				  	var metric_div = "#campaign_questions_attributes_"+iterator+"_metric_id";
				  	console.log(metric_div);
				  	var kpi_div = "#campaign_questions_attributes_"+iterator+"_kpi_id";
				  	if (div_id === metric_div){
					  	$("#campaign_questions_attributes_"+iterator+"_kpi_id").find('option').fadeOut().remove();
					  	$("label[for=campaign_questions_attributes_"+iterator+"_kpi_id]").fadeIn();
					  	$(kpi_div).append("<option selected='selected'>Select a KPI</option>");
					  	if (value){
						  	$.getJSON("/metrics/" + value + "/kpis", {} ).success(function(data) {
					  		 for (var i = 0; i < data.length; i++){
					  		 	var id = data[i].id;
					  		 	var kpi_name = data[i].kpi;
					  		 	var kpim = data[i].kpi_measurement;
					  		 	var options = "<option value='"+id+"'>"+kpi_name+"</option>";
					  		 	$(kpi_div).append(options);
					  		 	$('#kpim_'+iterator).fadeOut().remove();
					  		 	$("#campaign_questions_attributes_"+iterator+"_kpi_id").fadeIn();
					  		 	$("label[for=campaign_questions_attributes_"+iterator+"_kpi_id]").fadeIn();
					  		 }
					
					    	});
					    }else{
					    	$("#campaign_questions_attributes_"+iterator+"_kpi_id").fadeOut();
					    	$("label[for=campaign_questions_attributes_"+iterator+"_kpi_id]").fadeOut();
					    	$('#kpim_'+iterator).fadeOut().remove();
					    }
				   }
				   else if (div_id === kpi_div){
				   	if ( (value == 'Select a KPI') || (typeof value == 'null')){ 
				   		$('#kpim_'+iterator).remove();}
				   	else {
				   		$.getJSON("/kpis/"+ value, {} ).success(function(data) {
				   			console.log('bottom');
				  			console.log(data.kpi_measurement);
				  		 	var id = data.id;
				  		 	var kpi_name = data.kpi;
				  		 	var kpim = data.kpi_measurement;
				  		 	var kpim_id = "kpim_"+iterator;
				  		 	$("#"+ kpim_id).fadeOut().remove();
				  		 	$( "<p id='"+kpim_id+"'>"+kpim+"</p>" ).fadeIn().insertAfter( $("#campaign_questions_attributes_"+iterator+"_kpi_id") );
				  		 	
				  	    });
				      }
				   }
				  });
			  	} else if (div_id_no == metric_div){
			  		console.log("iterator=" + iterator);
			  		$(this).attr('id', "campaign_questions_attributes_"+iterator+"_metric_id");
			  		$(this).attr('name', "campaign[questions_attributes]["+iterator+"][metric_id]");
			  		$("#campaign_questions_attributes_"+iterator+"_kpi_id").find('option').fadeOut().remove();
			  		$(this).val("");
			  	} else{
			  		$(this).attr('id', "campaign_questions_attributes_"+iterator+"_kpi_id");
			  		$(this).attr('name', "campaign[questions_attributes]["+iterator+"][kpi_id]");
			  		$(this).hide();
			  		$(this).prev().attr('for', "campaign_questions_attributes_"+iterator+"_kpi_id");
			  		$(this).prev().hide();
			  		$(this).next().hide();
			  	}
		  	});
	    questions = $('.question-field').length;
	    console.log(questions);
	    if (questions === 2) {
	      $('.remove_fields').show();
	    }
	  });
  var eacherator = 0;
  $('.question-field select').each(function(){
  	eacherator = eacherator + 1;
  	console.log("eacherator " + eacherator);
  	var div_id = "#"+$(this).attr('id');
  	console.log(div_id);
  	var split = div_id.split('_');
  	var iterator = split[3];
  	var value = $(this,'option:selected').val();
  	var hidden_div = "#campaign_questions_attributes_"+iterator+"_id";
  	var hidden_value = $(hidden_div).val();
  	var metric_div = "#campaign_questions_attributes_"+iterator+"_metric_id";
  	var kpi_div = "#campaign_questions_attributes_"+iterator+"_kpi_id";
  	if (div_id == metric_div){
  	  console.log("hey" + value);
	  if (hidden_value){
		console.log('null hidden_value?');
		console.log('null value?');
		$.getJSON("/questions/" + hidden_value, {} ).success(function(data) {
	  		 var id = data.id;
	  		 var kpi_id = data.kpi_id;
	  		 var metric_id = data.metric_id;
	  		 console.log("this is me counting questions" + hidden_value);
			 if (metric_id){
			 	$.getJSON("/metrics/" + metric_id + "/kpis", {}).success(function(data){
			 	  for (var i = 0; i < data.length; i++){
		  		 	var id = data[i].id;
		  		 	var kpi_name = data[i].kpi;
		  		 	var kpim = data[i].kpi_measurement;
		  		 	console.log(hidden_value + " and " + kpim);
		  		 	console.log(kpim);
		  		 	if (kpi_id == id){
		  		 		var options = "<option selected='selected' value='"+id+"'>"+kpi_name+"</option>";
		  		 		var kpim_id = "kpim_"+iterator;
			  		 	$("#"+ kpim_id).fadeOut().remove();
			  		 	$( "<p id='"+kpim_id+"'>"+kpim+"</p>" ).fadeIn().insertAfter( $("#campaign_questions_attributes_"+iterator+"_kpi_id") );
		  		 	}else{
		  		 		var options = "<option value='"+id+"'>"+kpi_name+"</option>";
		  		 	}
		  		 	$(kpi_div).append(options);
		  		  }
			 		
			 	});
			 }
	  		 if (!kpi_id){
			  	console.log("kpi_id is null");
				$("#campaign_questions_attributes_"+iterator+"_kpi_id").fadeOut();
				$("label[for=campaign_questions_attributes_"+iterator+"_kpi_id]").fadeOut();
			  }
	    });
	 }else{
		$("#campaign_questions_attributes_"+iterator+"_kpi_id").fadeOut();
		$("label[for=campaign_questions_attributes_"+iterator+"_kpi_id]").fadeOut();
	 }
	}
  });
	  $('.question-field select').change(function(){
	  	console.log("LAST: " + $('.question-field:last select').attr('id'));
	  	console.log("fired");
	  	var div_id = "#"+$(this).attr('id');
	  	console.log(div_id);
	  	var split = div_id.split('_');
	  	var iterator = split[3];
	  	var value = $(this,'option:selected').val();
	  	var metric_div = "#campaign_questions_attributes_"+iterator+"_metric_id";
	  	console.log(metric_div);
	  	var kpi_div = "#campaign_questions_attributes_"+iterator+"_kpi_id";
	  	if (div_id === metric_div){
		  	$("#campaign_questions_attributes_"+iterator+"_kpi_id").find('option').fadeOut().remove();
		  	$(kpi_div).append("<option selected='selected'>Select a KPI</option>");
		  	if (value){
			  	$.getJSON("/metrics/" + value + "/kpis", {} ).success(function(data) {
		  		 for (var i = 0; i < data.length; i++){
		  		 	var id = data[i].id;
		  		 	var kpi_name = data[i].kpi;
		  		 	var kpim = data[i].kpi_measurement;
		  		 	var options = "<option value='"+id+"'>"+kpi_name+"</option>";
		  		 	$(kpi_div).append(options);
		  		 	$('#kpim_'+iterator).fadeOut().remove();
		  		 	$("#campaign_questions_attributes_"+iterator+"_kpi_id").fadeIn();
		  		 	$("label[for=campaign_questions_attributes_"+iterator+"_kpi_id]").fadeIn();
		  		 }
		
		    	});
		    }else{
		    	$("#campaign_questions_attributes_"+iterator+"_kpi_id").fadeOut();
		    	$("label[for=campaign_questions_attributes_"+iterator+"_kpi_id]").fadeOut();
		    	$('#kpim_'+iterator).fadeOut().remove();
		    }
	   }
	   else if (div_id === kpi_div){
	   	if ( (value == 'Select a KPI') || (typeof value == 'null')){ 
	   		$('#kpim_'+iterator).remove();}
	   	else {
	   		$.getJSON("/kpis/"+ value, {} ).success(function(data) {
	   			console.log('bottom');
	  			console.log(data.kpi_measurement);
	  		 	var id = data.id;
	  		 	var kpi_name = data.kpi;
	  		 	var kpim = data.kpi_measurement;
	  		 	var kpim_id = "kpim_"+iterator;
	  		 	$("#"+ kpim_id).fadeOut().remove();
	  		 	$( "<p id='"+kpim_id+"'>"+kpim+"</p>" ).fadeIn().insertAfter( $("#campaign_questions_attributes_"+iterator+"_kpi_id") );
	  		 	
	  	    });
	      }
	   }
	  });



			

